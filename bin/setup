#!/usr/bin/env bash
#
# Setup script for jonmagic/scripts
# Installs Bun (if needed), dependencies, and builds all packages.
#
# This project uses Bun exclusively. Do not use npm, yarn, or pnpm.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$ROOT_DIR"

echo "==> Setting up jonmagic/scripts..."

# Check for Bun
if ! command -v bun &> /dev/null; then
  echo "==> Bun not found. Installing..."
  curl -fsSL https://bun.sh/install | bash
  
  # Source bun for current session
  export BUN_INSTALL="$HOME/.bun"
  export PATH="$BUN_INSTALL/bin:$PATH"
  
  echo "==> Bun installed successfully."
else
  echo "==> Bun found: $(bun --version)"
fi

# Ensure no npm artifacts exist
if [[ -f "package-lock.json" ]]; then
  echo "==> Removing package-lock.json (this project uses bun.lock only)"
  rm package-lock.json
fi

# Install dependencies
echo "==> Installing dependencies with bun..."
bun install

# Build all packages
echo "==> Building packages..."
bun run build

echo ""
echo "==> Setup complete!"
echo ""
echo "Next steps:"
echo "  • Add CLI tools to your PATH:"
echo "    export PATH=\"$ROOT_DIR/packages/cli/bin:\$PATH\""
echo ""
echo "  • Install VS Code extension:"
echo "    bin/install-vscode-extension"
echo ""
echo "  • Install Raycast extension:"
echo "    bin/install-raycast-extension"
