#!/usr/bin/env ruby

# bin/prepare-commit: Prepare a commit message using staged changes and LLM.
#
# Generates a commit message from staged changes using the provided prompt template
# and opens the git commit editor for final review.
#
# Usage: prepare-commit --commit-message-prompt-path PATH [--llm-model MODEL]

require "open3"
require "optparse"
require "shellwords"
require "tempfile"

# --- Helper Methods ---

# Exits the script with an error message.
#
# message - The String error message to display.
#
# Returns nothing. Exits the script.
def error_exit(message)
  puts "Error: #{message}"
  exit 1
end

# Checks if a required command-line dependency is available in PATH.
#
# cmd - The String name of the command to check.
#
# Returns nothing. Exits if not found.
def check_dependency(cmd)
  system("which #{cmd} > /dev/null 2>&1") || error_exit("Required dependency '#{cmd}' not found in PATH.")
end

# Gets the staged git diff as a String.
#
# Returns the diff output as a String.
def staged_diff
  diff, _ = Open3.capture2("git diff --staged")
  diff
end

# Returns the model flag for the llm command, or an empty string if no model is specified.
#
# llm_model - The String model name or nil.
#
# Returns a String suitable for the llm command.
def llm_model_flag(llm_model)
  llm_model && !llm_model.strip.empty? ? "-m #{Shellwords.escape(llm_model)}" : ""
end

# Generates a commit message using the LLM, given the prompt and diff.
#
# prompt_path - The String path to the commit message prompt template.
# diff        - The String staged diff to provide as input.
# llm_model   - The String model name or nil.
#
# Returns the generated commit message as a String.
def generate_commit_msg(prompt_path, diff, llm_model)
  prompt_content = File.read(prompt_path)
  # Look for commit-message-guidelines.txt in the current directory
  guidelines_path = File.join(Dir.pwd, "commit-message-guidelines.txt")
  guidelines_content = File.exist?(guidelines_path) ? File.read(guidelines_path) : nil

  Tempfile.create(["llm_commit_prompt", ".txt"]) do |tmp|
    tmp.puts prompt_content
    tmp.puts guidelines_content if guidelines_content
    tmp.flush
    model_flag = llm_model_flag(llm_model)
    cmd = "llm #{model_flag} -f #{tmp.path}"
    msg, _ = Open3.capture2(cmd, stdin_data: diff)
    return msg.strip
  end
end



# === Main Script ===

# Step 1: Parse command-line options
options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: prepare-commit [options]"
  opts.on("--commit-message-prompt-path=PATH", "Path to commit message prompt template (required)") do |p|
    options[:prompt] = p
  end
  opts.on("--llm-model MODEL", "Model alias to use for llm -m (optional)") do |model|
    options[:llm_model] = model
  end
end.parse!

# Step 2: Validate prompt path
prompt_path = options[:prompt]
prompt_path = File.expand_path(prompt_path) if prompt_path
if prompt_path.nil? || prompt_path.strip.empty? || !File.exist?(prompt_path)
  error_exit("You must provide a valid path to the commit message prompt template using --commit-message-prompt-path.")
end

# Step 3: Get staged diff and validate
diff = staged_diff
if diff.strip.empty?
  error_exit("No staged changes found. Please stage your changes before running this script.")
end

# Step 4: Generate commit message using LLM
puts "Generating commit message..."
commit_msg = generate_commit_msg(prompt_path, diff, options[:llm_model])

# Step 5: Open git commit editor with message pre-filled
unless system("git", "commit", "--edit", "-m", commit_msg)
  error_exit("Git commit failed.")
end
